<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:f="http://xmlns.jcp.org/jsf/core"
      xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
      xmlns:pt="http://xmlns.jcp.org/jsf/passthrough">
<h:head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Directorio de Autores</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
</h:head>

<h:body class="bg-light">
    <div class="container py-4">

        <h1 class="h3 mb-4">Directorio de Autores</h1>

        <!-- ===== FORMULARIO ===== -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h2 class="h6 card-title mb-0">
                        #{authorBean.editMode ? 'Editar Autor' : 'Registrar Autor'}
                    </h2>
                    <span class="badge bg-secondary" title="Modo de formulario">
                    #{authorBean.editMode ? 'Edición' : 'Nuevo'}
                </span>
                </div>

                <h:form id="formAuthor">
                    <div class="row g-3">

                        <!-- Nombre -->
                        <div class="col-12">
                            <label for="name" class="form-label">Nombre del Autor:</label>
                            <h:inputText id="name"
                                         value="#{authorBean.author.fullName}"
                                         styleClass="form-control"
                                         required="true"
                                         requiredMessage="El nombre es obligatorio." />
                        </div>

                        <!-- Fecha de nacimiento -->
                        <div class="col-12 col-md-6">
                            <label for="birthdate" class="form-label">Fecha de Nacimiento:</label>
                            <h:inputText id="birthdate"
                                         value="#{authorBean.author.birthDate}"
                                         pt:type="date"
                                         converter="localDateConverter"
                                         styleClass="form-control"
                                         required="true"
                                         requiredMessage="La fecha de nacimiento es obligatoria." />
                        </div>

                        <!-- Teléfono -->
                        <div class="col-12 col-md-6">
                            <label for="phone" class="form-label">Teléfono:</label>
                            <h:inputText id="phone"
                                         value="#{authorBean.author.phone}"
                                         styleClass="form-control"
                                         maxlength="12" />
                        </div>

                        <!-- Género Literario -->
                        <div class="col-12">
                            <label for="genre" class="form-label">Género Literario:</label>
                            <h:selectOneMenu id="genre"
                                             value="#{authorBean.generoSeleccionado}"
                                             styleClass="form-select"
                                             required="true"
                                             requiredMessage="Debe seleccionar un género.">
                                <!-- opción nula compatible con Integer -->
                                <f:selectItem itemLabel="Seleccione..." itemValue="#{null}" noSelectionOption="true"/>
                                <f:selectItems value="#{authorBean.generos}" var="g"
                                               itemValue="#{g.id}" itemLabel="#{g.name}" />
                            </h:selectOneMenu>
                        </div>

                        <!-- Fecha de creación -->
                        <div class="col-12 col-md-6">
                            <label for="createdAt" class="form-label">Creado en:</label>
                            <h:inputText id="createdAt"
                                         value="#{authorBean.author.createdAt}"
                                         pt:type="datetime-local"
                                         converter="localDateTimeConverter"
                                         styleClass="form-control"
                                         pt:readonly="#{authorBean.editMode ? 'readonly' : null}" />
                            <!-- ^ si editMode=true, se deja solo lectura -->
                        </div>

                        <!-- Botones -->
                        <div class="col-12 text-center">
                            <h:commandButton value="#{authorBean.editMode ? 'Actualizar' : 'Guardar Autor'}"
                                             action="#{authorBean.guardarAutor}"
                                             styleClass="btn btn-dark px-4 me-2">
                                <f:ajax execute="@form"
                                        render=":formAuthor :formAuthor:msgs :formTable:tbl :formTable:total"/>
                            </h:commandButton>

                            <h:commandButton value="Cancelar"
                                             rendered="#{authorBean.editMode}"
                                             action="#{authorBean.nuevoAutor}"
                                             styleClass="btn btn-outline-secondary px-4">
                                <f:ajax execute="@this" render=":formAuthor :formAuthor:msgs"/>
                            </h:commandButton>
                        </div>

                        <!-- Mensajes -->
                        <div class="col-12">
                            <h:messages id="msgs"
                                        layout="list"
                                        infoClass="text-success mb-1"
                                        warnClass="text-warning mb-1"
                                        errorClass="text-danger mb-1"
                                        fatalClass="text-danger fw-bold mb-1"/>
                        </div>
                    </div>
                </h:form>
            </div>
        </div>

        <!-- ===== TABLA ===== -->
        <div class="card">
            <div class="card-body">
                <h2 class="h6 card-title mb-3">Autores Registrados</h2>

                <h:form id="formTable">
                    <h:panelGroup id="tbl">

                        <!-- Tabla si hay autores -->
                        <h:panelGroup rendered="#{not empty authorBean.listaAutores}">
                            <table class="table table-sm table-striped align-middle">
                                <thead class="table-light">
                                <tr>
                                    <th>ID</th>
                                    <th>Nombre</th>
                                    <th>Teléfono</th>
                                    <th>Fecha Nacimiento</th>
                                    <th>Género</th>
                                    <th>Creado</th>
                                    <th>Acciones</th>
                                </tr>
                                </thead>
                                <tbody>
                                <ui:repeat value="#{authorBean.listaAutores}" var="a">
                                    <tr>
                                        <td>#{a.id}</td>
                                        <td>#{a.fullName}</td>
                                        <td>#{a.phone}</td>
                                        <td><h:outputText value="#{a.birthDate}" converter="localDateConverter" /></td>
                                        <td>#{a.literaryGenre.name}</td>
                                        <td><h:outputText value="#{a.createdAt}" converter="localDateTimeConverter" /></td>
                                        <td class="text-nowrap">

                                            <!-- Editar en la misma vista -->
                                            <h:commandButton value="Editar"
                                                             action="#{authorBean.editarAutor(a)}"
                                                             styleClass="btn btn-outline-dark btn-sm me-1">
                                                <f:ajax execute="@this"
                                                        render=":formAuthor :formAuthor:msgs :formTable:tbl"/>
                                            </h:commandButton>

                                            <!-- Eliminar con setProperty + action sin parámetro -->
                                            <h:commandButton value="Eliminar"
                                                             action="#{authorBean.eliminarAutor}"
                                                             immediate="true"
                                                             onclick="return confirm('¿Eliminar este autor?');"
                                                             styleClass="btn btn-outline-danger btn-sm">
                                                <f:setPropertyActionListener target="#{authorBean.author}" value="#{a}"/>
                                                <f:ajax execute="@this"
                                                        render=":formTable:tbl :formTable:total :formAuthor:msgs"/>
                                            </h:commandButton>

                                        </td>
                                    </tr>
                                </ui:repeat>
                                </tbody>
                            </table>
                        </h:panelGroup>

                        <!-- Cuando no hay autores -->
                        <h:panelGroup rendered="#{empty authorBean.listaAutores}">
                            <div class="alert alert-info mb-0 text-center">
                                No hay autores registrados.
                            </div>
                        </h:panelGroup>

                    </h:panelGroup>

                    <div class="mt-3 text-end" id="total">
                        <small class="text-muted">
                            Total autores:
                            <strong>#{authorBean.conteoVisibles}</strong>
                        </small>
                    </div>
                </h:form>
            </div>
        </div>

    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</h:body>
</html>
